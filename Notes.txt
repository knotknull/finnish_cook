
##  Download and install chefdk
##

curl  https://packages.chef.io/files/stable/chefdk/2.4.17/el/7/chefdk-2.4.17-1.el7.x86_64.rpm  -o chefdk-2.4.17-1.el7.x86_64.rpm -#
sudo yum install chefdk-2.4.17-1.el7.x86_64.rpm


##  To install Guest Additions automatically in the Vagrant VM
##
vagrant plugin install vagrant-vbguest


##  When installing chef, it installs into /opt/chefdk but creates soft links from /usr/bin to chefdk i.e.:
##  NOTE:  need to update .bashrc to link git and ruby versions installed in /opt/chefdk/embedded
##
ls -l /usr/bin/chef
lrwxrwxrwx. 1 root root 20 Feb 20 14:18 /usr/bin/chef -> /opt/chefdk/bin/chef

## Enter the below to .bashrc to get environment to point to git
## and ruby installed with chef.
##
eval "$(chef shell-init bash)"

## Jargon Alert !!
##

   - Programs in Chef called recipe.
   - recipe:  file that contains chef code (*.rb = ruby)
   - Chef is Ruby Domain Specific Language
   - Resource (i.e. file below) building blocks for chef code
      - defines actions for chef to perform
      - bracketed by do / end statement pair
      - Generic layout of resource:
            <resource_type> '<name>' do
              <attribute statement>
            end
   - Attribute is a parameter to a resource


## Chef recipe exmple
##

hello.rb:
---------

file 'hello.txt' do
  content 'Welcome to Finnish Cook'
end

## NOTE: file name can be single or double quotes.  Content is an attribute
## or parameter that is passed to the file resource.
## https://docs.chef.io/resource_file.html
##

## To run chef code, call chef-apply, it runs single files of chef .rb code.
##
chef-apply hello.rb

## Creates a file called hello.txt with the content described in the chef file
##
[vagrant@chefbox share]$ ls -ltr
total 12
-rw-r--r--. 1 vagrant vagrant 21 Feb 20 22:55 itchy
-rw-r--r--. 1 vagrant vagrant 60 Feb 20 23:22 hello.rb
-rw-r--r--. 1 vagrant vagrant 23 Feb 20 23:24 hello.txt
[vagrant@chefbox share]$ cat hello.txt
Welcome to Finnish Cook


## Cookstyle: Chef took to check syntax (lint checker)
## eg.     cookstyle hello.rb

## Change ruby linter to cookstyle
##
1. Start Atom
2. Atom > Preferences > Install
3. In Search packages enter linter-rubocop
4. After install go to settings
5. In Settings > Command, enter:
/opt/chefdk/bin/cookstyle
6. tab out of field
7. test against a .rb file

## Automate verification w/ inspec
## inspec: Inspect Infrastructure
##
inspec runs tests to validate the infrastructure that is created
by you chef reciple that you create:

1. create hello_test.rb to hold testing code (_test is a convention)
NOTE: This test detects the existence of hello.txt as well as its' contents

describe file('hello.txt') do
  it { should be_file }
  its('content') { should match('Welcome to Finnish Cook') }
end

NOTE: brace {} are short cut for do / end


2. At cli run inspec w/ inspec test file
> inspec exec hello_test.rb

Profile: tests from hello_test.rb (tests from hello_test.rb)
Version: (not specified)
Target:  local://


  File hello.txt
     ✔  should be file
     ✔  content should match "Welcome to Finnish Cook"

Test Summary: 2 successful, 0 failures, 0 skipped


Anatomy of a test file
- Verification building block
describe <resource_type> '<name>' do
  <checks>
end

INSPEC EXMAPLES at: https://docs.chef.io/inspec_reference.html
NOTE: resources mentioned in chef recipe will most likely have an 'audit'
inspec resource by the same name i.e. file.



 - Chef is a declarative language to express desired state (like SQL)

   -----------      ------------
  |           |    |            |      --------
  | resources |    | attributes |  -> | recipe |    <-    chef
  |           |    |            |      --------
   -----------      ------------

   - chef looks at resources and attributes in recipe and figures out how
     to get to desired state

   - You specify what end result must look like (desired state) not
     how to achieve it.

NOTE: can reference env vars as:   "#{ENV['HOME']}
      variable reference == #{}
      A string MUST have double quotes if it contains a variable reference to
      substitute the value of the variable, otherwise it would just print
      the varialbe name.  ENV variable is referenced as a hash:
             ${HOME} == #{ENV['HOME']}

     file "#{ENV['HOME']}/stone.txt" do
       content 'Written to stone.txt'
     end

## How to do an uninstall (by telling chef what NOT to do)
##
##  Resource Driven vs. Attribute Drive unistall

## Resource Driven
##
All resources can define what NOT to do.  For example, for file resource you
can change action.

i.e. implicit default action for file is create action.  To override the
default action explicitly call the delete action.
The ":" denotes a constant value (aka ruby symbol)

 file "#{ENV['HOME']}/stone.txt" do
   action :delete
 end

NOTE: Cannot provide a default "Undo" function.  Can use limited uninstall using
Attribute Driven uninstall
https://code.facebook.com/posts/1909042435988955/facebook-chef-cookbooks/

Scaling systems configuration at Facebook
https://www.youtube.com/watch?v=-YtZiVxEiJ8


## Chef Concepts
   - recipe:    file containing Chef code
   - resource:  abstraction for something managed by Chef (i.e. file)
   - attribute: parameters passed to a resource


##################################################################
##  Test Kitchen
##################################################################

Test Kitchen tool to deploy recipes to sandbox environment. Test Kitchen
creates a sandbox environment that simulates production env.

Test kitchen uses docker to create sandbox env.

> kitchen --version
Test Kitchen version 1.19.2

kitchen-dokken: test-kitchen plugin that provisions rapid cookbook
testing and container development using Docker and Chef

Run initialization command for kitchen env:
> kitchen init --driver=kitchen-dokken --provisioner=dokken
create  .kitchen.yml
create  chefignore
create  test/integration/default

NOTE: creates :
  .kitchen.yml:  configuration file for sandbox environment
  chefignore:    configuration file used for when you package up environment
  test:          creates test directory for inspec tests

## Verify kitchen.yml
##
Verify kitchen.yml file using command:  kitchen list

> kitchen list
Instance          Driver  Provisioner  Verifier  Transport  Last Action    Last Error
default-centos73  Dokken  Dokken       Inspec    Dokken     <Not Created>  <None>


## Create test instance: kitchen create
##
> kitchen create --log_level=debug
-----> Starting Kitchen (v1.19.2)
-----> Creating <default-centos73>...
D      driver - pulling chef/chef:latest centos 7.3.1611
D      driver - pulling chef/chef:latest chef/chef latest
D      driver - creating volume container chef-latest from chef/chef:latest
       Creating container chef-latest
D      driver - create_container args {"name"=>"chef-latest", "Cmd"=>"true", "Image"=>"chef/chef:latest", "HostConfig"=>{"NetworkMode"=>"dokken"}}
       Creating kitchen sandbox at /home/vagrant/.dokken/kitchen_sandbox/8d7db201dc-default-centos73
       Creating verifier sandbox at /home/vagrant/.dokken/verifier_sandbox/8d7db201dc-default-centos73
       Building work image..
D      driver - starting 8d7db201dc-default-centos73
       Creating container 8d7db201dc-default-centos73
D      driver - create_container args {"name"=>"8d7db201dc-default-centos73", "Cmd"=>["sh", "-c", "trap exit 0 SIGTERM; while :; do sleep 1; done"], "Image"=>"8d7db201dc-default-centos73:latest", "Hostname"=>"dokken", "Env"=>nil, "ExposedPorts"=>nil, "Volumes"=>nil, "HostConfig"=>{"Privileged"=>false, "VolumesFrom"=>["chef-latest"], "Binds"=>["/home/vagrant/.dokken/kitchen_sandbox/8d7db201dc-default-centos73:/opt/kitchen", "/home/vagrant/.dokken/verifier_sandbox/8d7db201dc-default-centos73:/opt/verifier"], "Dns"=>nil, "DnsSearch"=>nil, "Links"=>[], "CapAdd"=>[], "CapDrop"=>[], "SecurityOpt"=>[], "NetworkMode"=>"dokken", "PortBindings"=>nil, "Tmpfs"=>{}}, "NetworkingConfig"=>{"EndpointsConfig"=>{"dokken"=>{"Aliases"=>["dokken"]}}}}
       Finished creating <default-centos73> (1m6.46s).
-----> Kitchen is finished. (1m7.99s)


##  verify test instance was created: kitchen list
##
> kitchen list
Instance          Driver  Provisioner  Verifier  Transport  Last Action  Last Error
default-centos73  Dokken  Dokken       Inspec    Dokken     Created      <None>

NOTE: Last Action changed from  <Not Created> to Created !!

##  verify the running vm instances via docker
##
> docker ps
docker ps
CONTAINER ID        IMAGE                                COMMAND                  CREATED             STATUS              PORTS               NAMES
97c627d7f537        8d7db201dc-default-centos73:latest   "sh -c 'trap exit 0 S"   7 minutes ago       Up 7 minutes                            8d7db201dc-default-centos73


##  Login to the running test kitchen vm via: kitchen login default-centos73
##
> kitchen login default-centos73

##  Destroy the test kitchen vm via: kitchen destroy default-centos73
##
> kitchen destroy default-centos73
-----> Starting Kitchen (v1.19.2)
-----> Destroying <default-centos73>...
       Deleting kitchen sandbox at /home/vagrant/.dokken/kitchen_sandbox/8d7db201dc-default-centos73
       Deleting verifier sandbox at /home/vagrant/.dokken/verifier_sandbox/8d7db201dc-default-centos73
       Finished destroying <default-centos73> (0m0.28s).
-----> Kitchen is finished. (0m1.83s)

# Verify that running instance is destroyed via: kitchen list
> kitchen list
Instance          Driver  Provisioner  Verifier  Transport  Last Action    Last Error
default-centos73  Dokken  Dokken       Inspec    Dokken     <Not Created>  <None>

# Verify that running instance is destroyed via: docker ps
> docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES







##
